---
title: 6. アプリを Azure Functions と Azure Container Apps にデプロイする
sidebar_position: 6
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 演習 6

## アプリを Azure Functions と Azure Container Apps にデプロイする

:::info
[このチュートリアルの前提条件](/MicrosoftCloud/tutorials/docs/ACS-to-Teams-Meeting/) に加えて、この演習を完了するには Azure CLI をインストールする必要があります。

- [Azure CLI](https://learn.microsoft.com/cli/azure/install-azure-cli)
:::

この演習では、これまでの演習で取り上げた Microsoft Graph と ACS の Functions を Azure Functions にデプロイする方法を学びます。
また、コンテナ イメージを構築し Azure Container Apps にデプロイします。

![Azure Container Apps](/img/acs-to-teams/6-deploy-container-apps.png "Azure Container Apps")

### Azure Functions にデプロイする

Visual Studio 2022 を使用して Azure Functions にデプロイを行いましょう。

1. `samples/acs-video-to-teams-meeting/server/csharp/GraphACSFunctions.sln` を Visual Studio 2022 で開きます。

2. ソリューション エクスプローラーの `GraphACSFunctions` プロジェクトの上で右クリックします。

3. `コンテキスト メニュー --> 発行` を選択します。

4. ターゲットで `Azure` を選択して `次へ` を選択します。

5. `Azure Function App (Windows)` を選択して `次へ` を選択します。

6. デプロイ先のサブスクリプションを選択 (Azure のサブスクリプションに紐づくアカウントでサインインをしていない場合はサインインを行ってください) して `+ 新規作成` を選択します。

7. 以下の内容を入力して `作成` を選択します:
   - 名前: 任意の名前 (ワールドワイドで一意である必要があります)
   - サブスクリプション名: デプロイ先のサブスクリプション
   - リソースグループ: デプロイ先のリソースグループ (必要であれば新規作成をしてください)。ここまでの演習で使用してきたリソース グループも使用できます。
   - プランの種類: 消費
   - 場所: デプロイ先のリージョン
   - Azure Storage: 新規作成をしてください (既存のものを使用することもできます)
   - Application Insights: 新規作成をしてください (既存のものを使用することもできます)

8. 作成が完了すると作成した Azure Function App が選択された状態になるので `パッケージ ファイルから実行します (推奨)` にチェックが入っていることを確認して `完了` を選択します。

9. 発行プロファイルが作成されるので `発行` ボタンを選択して Azure にデプロイを行います。

11. デプロイが完了したら Azure ポータルで作成した Function App を選択します。

12. 概要にある URL をコピーしてローカル ファイルに保存してください。演習の後半で使用します。

13. Function App の `設定 --> 構成` を選択してください。

14. `+ 追加` ボタンを押して以下のキーと値を `アプリケーション設定` に追加してください。これらの値は Visual Studio の `GraphACSFunctions` プロジェクトの `local.settings.json` から取得してください。

    ```
    # これらの値を local.settings.json ファイルから取得
    TENANT_ID: <YOUR_VALUE>
    CLIENT_ID: <YOUR_VALUE>
    CLIENT_SECRET: <YOUR_VALUE>
    USER_ID: <YOUR_VALUE>
    ACS_CONNECTION_STRING: <YOUR_VALUE>
    ```

15. Azure ポータルの構成画面の上部にある `保存` ボタンを選択してください。

16. 最後に Function App の Web API を別ドメインの Web アプリから呼び出せるように CORS の設定を行います。`API --> CORS` を選択してください。

17. 許可される元ドメインに `*` (どのドメインからの呼び出しも受け入れるという設定) を入力して `保存` を選択してください。

### Azure Container Apps にデプロイする

1. 最初に新しい [Azure Container Registry (ACR)](https://learn.microsoft.com/azure/container-registry/container-registry-get-started-azure-cli) リソースを作成します。リソースを作成した後に、イメージをビルドしてレジストリにプッシュします。

2. コマンド ウィンドウを開き以下のコマンドを実行して Azure サブスクリプションにログインします:

    ```bash
    az login
    ```

3. プレースホルダーを自分の値に変更して以下のシェル変数を追加します。`<GITHUB_USERNAME>`を小文字で追加して、`<AZURE_FUNCTIONS_DOMAIN>` に Azure Functions のドメインを代入します (ドメインには `https://` を含む)。

    <Tabs>
    <TabItem value="bash" label="Bash">

    ```bash
    GITHUB_USERNAME="<YOUR_GITHUB_USERNAME>"
    RESOURCE_GROUP="<YOUR_RESOURCE_GROUP_NAME>"
    ACR_NAME="aca"$GITHUB_USERNAME
    AZURE_FUNCTIONS_DOMAIN="<YOUR_AZURE_FUNCTIONS_URL>"
    ```

    </TabItem>
    <TabItem value="powershell" label="PowerShell">

    ```powershell
    $GITHUB_USERNAME="<YOUR_GITHUB_USERNAME>"
    $RESOURCE_GROUP="<YOUR_RESOURCE_GROUP_NAME>"
    $ACR_NAME="aca"+$GITHUB_USERNAME
    $AZURE_FUNCTIONS_DOMAIN="<YOUR_AZURE_FUNCTIONS_URL>"
    ```

    </TabItem>
    </Tabs>

4. 以下のコマンドを実行して、新しい ACR リソースを作成します:

    <Tabs>
    <TabItem value="bash" label="Bash">

    ```bash
    az acr create \
        --resource-group $RESOURCE_GROUP \
        --name $ACR_NAME \
        --sku Basic \
        --admin-enabled true
    ```

    </TabItem>
    <TabItem value="powershell" label="PowerShell">

    ```powershell
    az acr create `
        --resource-group $RESOURCE_GROUP `
        --name $ACR_NAME `
        --sku Basic `
        --admin-enabled true
    ```

    </TabItem>
    </Tabs>

5. `samples/acs-video-to-teams-meeting/client/react/Dockerfile` をエディターで開いて、以下のタスクが実行されていることを確認します:

    - `build` ステージで React アプリケーションがビルドされています。
    - ngnx サーバーが設定され、`build` ステージの出力が nginx サーバー イメージにコピーされています。

6. `samples/acs-video-to-teams-meeting/client/react` フォルダーので、以下のコマンドを実行して、Azure のコンテナーイメージを構築します。

    <Tabs>
    <TabItem value="bash" label="Bash">

    ```bash
    az acr build --registry $ACR_NAME --image acs-to-teams-meeting \
      --build-arg REACT_APP_ACS_USER_FUNCTION=$AZURE_FUNCTIONS_DOMAIN/api/ACSTokenFunction \
      --build-arg REACT_APP_TEAMS_MEETING_FUNCTION=$AZURE_FUNCTIONS_DOMAIN/api/TeamsMeetingFunction .
    ```

    </TabItem>
    <TabItem value="powershell" label="PowerShell">

    ```powershell
    az acr build --registry $ACR_NAME --image acs-to-teams-meeting `
      --build-arg REACT_APP_ACS_USER_FUNCTION="$AZURE_FUNCTIONS_DOMAIN/api/ACSTokenFunction" `
      --build-arg REACT_APP_TEAMS_MEETING_FUNCTION="$AZURE_FUNCTIONS_DOMAIN/api/TeamsMeetingFunction" .
    ```

    </TabItem>
    </Tabs>

7. 以下のコマンドを実行してレジストリ内のイメージの一覧を表示します。新しいイメージが表示されます。

    ```bash
    az acr repository list --name $ACR_NAME --output table
    ```

8. イメージがデプロイされたので、コンテナを実行するための Azure Container App を作成します。

9. https://portal.azure.com をブラウザーで開いてサインインを行います。

10. 画面上部の検索バーに `コンテナー アプリ` と入力して、表示された `コンテナー アプリ` を選択します。

11. ツールバーの `作成` を選択します。

    :::note
    Azure Portal を使用していますが、Azure CLI を使用してもコンテナアプリを作成することができます。詳しくは、[Quickstart: Deploy your first container app](https://learn.microsoft.com/azure/container-apps/get-started)をご覧ください。この演習の最後にも、Azure CLIを使用する例があります。
    :::

12. 以下のタスクを実行します:
    - 使用するサブスクリプションを選択。
    - 使用するリソース グループ (必要があれば新規作成) を選択。ACS のリソースのために作成したものと同じリソース グループも使用できます。リソース グループ名をコピーして Azure Functions のドメインを保存したのと同じローカル ファイルに保存します。
    - コンテナー アプリ名に `acs-to-teams-meeting` と入力。
    - リージョンを選択。
    - **コンテナー アプリ 環境** で **新規作成** を選択。
    - **環境名** に `acs-to-teams-meeting-env` と入力。
    - **Create** ボタンを選択。
    - **次へ: アプリ設定 >** を選択。

13. **コンテナー アプリの作成** 画面で以下の値を入力します:

    - **クイックスタート イメージを使用する** のチェックを外す。
    - **名前**: `acs-to-teams-meeting`
    - **イメージのソース**: `Azure Container Registry`
    - **レジストリ**: `<YOUR_ACR_REGISTRY_NAME>.azurecr.io`
    - **イメージ**: `acs-to-teams-meeting`
    - **イメージ タグ**: `latest`
    - **CPU とメモリ**: `0.25 CPU コア、0.5 Gi メモリ`

14. **アプリケーションのイングレス設定** のセクションで、以下の設定を行います:

    - **有効** のチェックボックスを選択。
    - **どこからでもトラフィックを受け入れます** のラジオ ボタンを選択。

    :::note
    これにより、React アプリケーションのエントリ ポイント (イングレス) が作成され、何処からでも呼び出すことが出来るようになります。Azure Contaienr Apps は全てのトラフィックを HTTPS にリダイレクトします。
    :::

    - **ターゲット ポート**: `80` 
    
    :::note
    これは nginx サーバーのデフォルトのポートです。
    :::

15. **確認と作成** を選択します。確認が完了したら **作成** ボタンを選択します。

   :::info
   エラーが発生した場合、コンテナアプリの環境が長い間非アクティブであったことが原因である可能性があります。最も簡単な解決策は、コンテナ アプリの作成プロセスを再度実行することです。または、以下のコマンドを実行し、Azure CLI を使用してコンテナアプリを作成することもできます:

    <Tabs>
    <TabItem value="bash" label="Bash">

    ```bash
    az containerapp create --name acs-to-teams-meeting --resource-group $RESOURCE_GROUP \
        --location westus --image acs-to-teams-meeting \
        --cpu 0.25 --memory 0.5 --environment-name acs-to-teams-meeting-env \
        --ingress-enabled true --ingress-target-port 80 --ingress-type External \
        --ingress-protocol Https --ingress-traffic Anywhere
    ```

    </TabItem>
    <TabItem value="powershell" label="PowerShell">

    ```powershell
    az containerapp create --name acs-to-teams-meeting --resource-group $RESOURCE_GROUP `
        --location westus --image acs-to-teams-meeting `
        --cpu 0.25 --memory 0.5 --environment-name acs-to-teams-meeting-env `
        --ingress-enabled true --ingress-target-port 80 --ingress-type External `
        --ingress-protocol Https --ingress-traffic Anywhere
    ```

    </TabItem>
    </Tabs>
   :::

16. コンテナ アプリのデプロイが完了したら、Azure ポータルでコンテナ アプリに移動して、**概要**画面 の **アプリケーション URL** を選択すると nginx コンテナで実行中のアプリが表示されます。
